
<!DOCTYPE HTML>

  <html>
    
    <head>
      <meta charset="utf-8">
      <title>Tutorial: HTML Audio Capture streaming to Node.js (no browser extensions) - Wrong Way</title>
      <meta name="author" content="Gabriel PoÃ§a">

      
      <meta name="description" content="Tutorial: HTML Audio Capture Streaming to Node.js (No Browser Extensions)
This blog post was written for Group Buddies Blog. I&rsquo;m taking the &hellip;">
      

      <!-- http://t.co/dKP3o1e -->
      <meta name="HandheldFriendly" content="True">
      <meta name="MobileOptimized" content="320">
      <meta name="viewport" content="width=device-width, initial-scale=1">

      <link href="/atom.xml" rel="alternate" title="Wrong Way" type="application/atom+xml">
      
      <link rel="canonical" href="http://gabrielpoca.com/blog/2014/06/24/streaming-microphone-from-browser-to-nodejs-no-plugin/">
      <link href="/favicon.ico" rel="shortcut icon">
      <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
      <link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
      <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
      
      
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', '82577395']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


    </head>


<body>
  <div class="container">
    <div class="left-col">
      <div class="intrude-less">
        <header id="header" class="inner"><div class="profilepic">
  <img src="http://www.gravatar.com/avatar/685cd58e0e6dc5b1219027ea22e47d9d?s=160" alt="Profile Picture" style="width: 160px;" />
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
			<a class="twitter" href="http://twitter.com/gabrielgpoca" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/gabrielpoca" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
      </div>
    </div>	
    <div class="mid-col">
      
      
      
      <div class="mid-col-container">
        <div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
<h1 class="title" itemprop="name">Tutorial: HTML Audio Capture Streaming to Node.js (No Browser Extensions)</h1>
<div class="entry-content" itemprop="articleBody"><p>This blog post was written for <a href="http://blog.groupbuddies.com/posts/39-tutorial-html-audio-capture-streaming-to-node-js-no-browser-extensions">Group Buddies Blog</a>.</p>

<p>I&rsquo;m taking the time to write the tutorial I wish I had some months ago. My task was to set up some user voice recording mechanism in the browser. It should record for about one hour, non-stop, saving to a server. The idea was to use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator.getUserMedia">getUserMedia()</a> API. No browser extensions should be used.</p>

<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator.getUserMedia">getUserMedia()</a> API allows web apps to request access to a media device such as a camera or microphone. It yields raw PCM data.</p>

<h2>Round One</h2>

<p>We approached the task looking for the smallest change that solved the problem. We did it using <a href="https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC">RecordRTC</a>. It records the microphone in the browser. When finished, we can upload it to a server through a normal request. Let me show you how it works.</p>

<p>Add the RecordRTC library.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//www.WebRTC-Experiment.com/RecordRTC.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Request access to the microphone.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">audio</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">video</span><span class="o">:</span> <span class="kc">false</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">recordRTC</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'><span class="nx">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mediaStream</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">recordRTC</span> <span class="o">=</span> <span class="nx">RecordRTC</span><span class="p">(</span><span class="nx">MediaStream</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">recordRTC</span><span class="p">.</span><span class="nx">startRecording</span><span class="p">();</span>
</span><span class='line'><span class="p">},</span> <span class="nx">onError</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>When finished recording, stop and upload to a server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">recordRTC</span><span class="p">.</span><span class="nx">stopRecording</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">audioURL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;edition[audio]&#39;</span><span class="p">,</span> <span class="nx">recordRTC</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">())</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;some/path&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span> <span class="nx">formData</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">contentType</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">cache</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code works, but you shouldn&rsquo;t write code like this, it&rsquo;s just an example.</p>

<h3>Drawbacks</h3>

<p>Audio is recorded in wav format. An one hour recording, with one channel, can take around 500mb. This is a problem for the browser limited memory. Also the upload would take ages! It wasn&rsquo;t working.</p>

<h2>Round Two</h2>

<p>After reading the source code from <a href="https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC">RecordRTC</a> (ugly) and <a href="https://github.com/mattdiamond/Recorderjs">RecorderJS</a>, I realised that using a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ScriptProcessorNode">ScriptProcessorNode</a> I can write JavaScript to send data chunks (audio samples) from the microphone to a server.</p>

<p>Turns out it&rsquo;s harder than it seems, mostly because of the lack of information. There are a couple of related Stack Overflow answers (I will add them in the end), but I won&rsquo;t bother you with this. Let&rsquo;s move on to the code.</p>

<h3>Reading data from the microphone</h3>

<p>First request microphone access.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">audio</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">video</span><span class="o">:</span> <span class="kc">false</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">recordRTC</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'><span class="nx">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">initializeRecorder</span><span class="p">,</span> <span class="nx">onError</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Having the microphone stream you can use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext">AudioContext</a> interface to make the audio (PCM data) go through different processing nodes before reaching its destination. There are nodes for gain, compressor, panner, and much more. We are going to write a custom node, so we can access the audio samples. For that we add a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ScriptProcessorNode">ScriptProcessorNode</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">initializeRecorder</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">audioContext</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">AudioContext</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">audioContext</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">audioInput</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">createMediaStreamSource</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">bufferSize</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// create a javascript node</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">recorder</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">createJavaScriptNode</span><span class="p">(</span><span class="nx">bufferSize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">// specify the processing function</span>
</span><span class='line'>  <span class="nx">recorder</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="nx">recorderProcess</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// connect stream to our recorder</span>
</span><span class='line'>  <span class="nx">audioInput</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">recorder</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">// connect our recorder to the previous destination</span>
</span><span class='line'>  <span class="nx">recorder</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After this, every audio sample will go through the <code>recorderProcess</code> function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">recorderProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">inputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have now PCM data samples from the left channel. Since we are recording in mono we only need the left channel. Now moving on to streaming these chunks to the server.</p>

<h3>Communication</h3>

<p>We are using WebSockets to send the samples to the server. The server is going to be written in Node.js.</p>

<p>I started with <a href="http://socket.io/">Socket.IO</a>. When things didn&rsquo;t work I realised Socket.IO doesn&rsquo;t support binary communication (in fact, it does now, I made this before it did). <a href="http://binaryjs.com/">BinaryJS</a> does support binary communication, so I moved to it.</p>

<h4>Setup BinaryJS</h4>

<p>First add the BinaryJS library.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://cdn.binaryjs.com/0/binary.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now start a connection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BinaryClient</span><span class="p">(</span><span class="s1">&#39;ws://localhost:9001&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>When ready, create a write stream.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// for the sake of this example let&#39;s put the stream in the window</span>
</span><span class='line'>  <span class="nb">window</span><span class="p">.</span><span class="nx">Stream</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">createStream</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Going back to our custom node let&rsquo;s send the audio to the stream.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">recorderProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">inputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="nb">window</span><span class="p">.</span><span class="nx">Stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">left</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Everything should be ready on the client side now. Our <code>recorderProcess</code> function is called for each audio chunk, and each is sent to the server.</p>

<p>But we aren&rsquo;t ready yet! There is one important step missing. WebAudio samples are in Float32. If you choose to send them like this you need to know that <a href="https://developer.mozilla.org/en-US/docs/Web/API/Uint16Array">endianness does matter</a>. I chose to convert them to 16 bit signed integers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">convertFloat32ToInt16</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">l</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int16Array</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
</span><span class='line'>  <span class="k">while</span> <span class="p">(</span><span class="nx">l</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">buf</span><span class="p">[</span><span class="nx">l</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">l</span><span class="p">])</span><span class="o">*</span><span class="mh">0x7FFF</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">recorderProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">inputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="nb">window</span><span class="p">.</span><span class="nx">Stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">convertFloat32ToInt16</span><span class="p">(</span><span class="nx">left</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We are now done with the client code. Moving on to the server.</p>

<h3>Setting up a server</h3>

<p>I&rsquo;m not getting into much detail on the server, I&rsquo;m just going to show how to put these chunks in a playable media file. I&rsquo;m assuming you already have <a href="http://nodejs.org/">Node.js</a> installed.</p>

<p>We need <a href="http://binaryjs.com/">BinaryJS</a>, and <a href="https://github.com/TooTallNate/node-wav">node-wav</a> on the server. The first is for communication, and the second accepts raw audio data and outputs a WAV file with a valid WAVE header.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>npm init
</span><span class='line'>npm install binaryjs
</span><span class='line'>npm install wav
</span></code></pre></td></tr></table></div></figure>


<p>Now create the <code>index.js</code> file and start the BinaryJS server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">binaryServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;binaryjs&#39;</span><span class="p">).</span><span class="nx">BinaryServer</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">wav</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;wav&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">binaryServer</span><span class="p">({</span><span class="nx">port</span><span class="o">:</span> <span class="mi">9001</span><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Inside the <code>server.on('connection', function)</code> callback node-wav is going to help pipe the stream into a file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fileWriter</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">meta</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">fileWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wav</span><span class="p">.</span><span class="nx">FileWriter</span><span class="p">(</span><span class="s1">&#39;demo.wav&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">channels</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">sampleRate</span><span class="o">:</span> <span class="mi">48000</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">bitDepth</span><span class="o">:</span> <span class="mi">16</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nx">stream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">fileWriter</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">fileWriter</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">fileWriter</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>For a better understanding you should read <a href="https://github.com/TooTallNate/node-wav">node-wav</a> document. In fact, you should read the source code since there isn&rsquo;t much documentation. Simply put, <code>wav.FileWriter</code> accepts a pcm stream and sends it to a media file, setting the right header for the file.</p>

<p>Notice the settings for <code>wav.FileWriter</code> are hardcoded, but they can be sent through the stream. Parameters like sample rate change for each client.</p>

<h2>Setup complete</h2>

<p>You are ready to start recording. There is still a long way to go from here. You should probably support restoring the connection if it goes down, and append the audio to the same media.</p>

<h1>Wrap it up</h1>

<p>You can now start from here and build your own platform with audio recording. Maybe a personal note-taking platform.</p>

<p>This solution allows you to record the microphone while not worrying about upload time and audio loss. The full source code is <a href="https://github.com/gabrielpoca/browser-pcm-stream">here</a>. Feel free to leave any questions and comments.</p>

<h3>StackOverflow related answers</h3>

<ul>
<li><a href="http://stackoverflow.com/questions/21079972/sound-card-detection-for-web/21080953#21080953">Sound card detection for web</a></li>
<li><a href="http://stackoverflow.com/questions/20876152/playing-pcm-stream-from-web-audio-api-on-node-js">Playing PCM stream from Web Audio API on Node.js</a></li>
<li><a href="http://stackoverflow.com/questions/20850396/stream-recorded-audio-from-browser-to-server">Stream recorded audio from browser to server</a></li>
</ul>

</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
      </div>
      <footer id="footer" class="inner">Copyright &copy; 2014

    Gabriel PoÃ§a


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
    </div>
  </div>
  

</body>
</html>
