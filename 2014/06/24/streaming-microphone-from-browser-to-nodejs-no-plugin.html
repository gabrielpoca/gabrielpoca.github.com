<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Tutorial: HTML Audio Capture streaming to Node.js (no browser extensions)</title>
  <meta name="description" content="This blog post was written for Group Buddies Blog.">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://gabrielpoca.com/2014/06/24/streaming-microphone-from-browser-to-nodejs-no-plugin.html">
  <link rel="alternate" type="application/rss+xml" title="Gabriel Poça" href="http://gabrielpoca.com/feed.xml" />

  <!--<link href='http://fonts.googleapis.com/css?family=Merriweather:400,300,700,900,400italic,300italic' rel='stylesheet' type='text/css'>-->
  <link href='http://fonts.googleapis.com/css?family=Raleway:700,400|Merriweather:400italic,400,300italic,300,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js">
  </script>

  <script src="/js/app.js">
  </script>
</head>

  <body>
    <div class="Layout">
      <div class="Layout-sidebar">
        <div class="Sidebar">
  <div class="Sidebar-contentWrapper">
    <div class="Sidebar-picture">
      <img class="Gravatar" alt="Profile Picture" src="https://www.gravatar.com/avatar/2c4b850cf6a0a3be7a18c7840bc12435?s=600&r=g&d=mm"></img>
    </div>
    <h2 class="Sidebar-title">Gabriel Poça</h2>
    <nav class="Sidebar-social">
      <ul>
        
        <li class="Sidebar-socialItem">
          <a href="https://github.com/gabrielpoca"
            target="_blank"><i class="fa fa-github"></i></a>
        </li>
        

        
        <li class="Sidebar-socialItem">
          <a href="https://twitter.com/gabrielgpoca"
            target="_blank"><i class="fa fa-twitter"></i></a>
        </li>
        

        <li class="Sidebar-socialItem">
          <a href="/feed.xml"
            target="_blank"><i class="fa fa-rss"></i></a>
        </li>
      </ul>
    </nav>
  </div>
</div>

      </div>

      <div class="Layout-content">
        <div class="Page">

  <div class="Post">
    <header class="Post-header">
      <h1 class="Post-title">Tutorial: HTML Audio Capture streaming to Node.js (no browser extensions)</h1>
      <p class="post-meta">Jun 24, 2014</p>
    </header>

    <article class="Post-content">
      <p>This blog post was written for <a href="http://blog.groupbuddies.com/posts/39-tutorial-html-audio-capture-streaming-to-node-js-no-browser-extensions">Group Buddies Blog</a>.</p>

<p>I’m taking the time to write the tutorial I wish I had some months ago. My task was to set up some user voice recording mechanism in the browser. It should record for about one hour, non-stop, saving to a server. The idea was to use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator.getUserMedia">getUserMedia()</a> API. No browser extensions should be used.</p>

<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator.getUserMedia">getUserMedia()</a> API allows web apps to request access to a media device such as a camera or microphone. It yields raw PCM data.</p>

<h2 id="round-one">Round One</h2>

<p>We approached the task looking for the smallest change that solved the problem. We did it using <a href="https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC">RecordRTC</a>. It records the microphone in the browser. When finished, we can upload it to a server through a normal request. Let me show you how it works.</p>

<p>Add the RecordRTC library.</p>

<pre><code class="language-html">&lt;script src="//www.WebRTC-Experiment.com/RecordRTC.js"&gt;&lt;/script&gt;
</code></pre>

<p>Request access to the microphone.</p>

<pre><code class="language-javascript">var session = {
  audio: true,
  video: false
};
var recordRTC = null;
navigator.getUserMedia(session, function (mediaStream) {
  recordRTC = RecordRTC(MediaStream);
  recordRTC.startRecording();
}, onError);
</code></pre>

<p>When finished recording, stop and upload to a server.</p>

<pre><code class="language-javascript">recordRTC.stopRecording(function(audioURL) {
  var formData = new FormData();
  formData.append('edition[audio]', recordRTC.getBlob())
  $.ajax({
    type: 'POST',
    url: 'some/path',
    data: formData,
    contentType: false,
    cache: false,
    processData: false,
  })
});
</code></pre>

<p>The code works, but you shouldn’t write code like this, it’s just an example.</p>

<h3 id="drawbacks">Drawbacks</h3>

<p>Audio is recorded in wav format. An one hour recording, with one channel, can take around 500mb. This is a problem for the browser limited memory. Also the upload would take ages! It wasn’t working.</p>

<h2 id="round-two">Round Two</h2>

<p>After reading the source code from <a href="https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC">RecordRTC</a> (ugly) and <a href="https://github.com/mattdiamond/Recorderjs">RecorderJS</a>, I realised that using a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ScriptProcessorNode">ScriptProcessorNode</a> I can write JavaScript to send data chunks (audio samples) from the microphone to a server.</p>

<p>Turns out it’s harder than it seems, mostly because of the lack of information. There are a couple of related Stack Overflow answers (I will add them in the end), but I won’t bother you with this. Let’s move on to the code.</p>

<h3 id="reading-data-from-the-microphone">Reading data from the microphone</h3>

<p>First request microphone access.</p>

<pre><code class="language-javascript">var session = {
  audio: true,
  video: false
};
var recordRTC = null;
navigator.getUserMedia(session, initializeRecorder, onError);
</code></pre>

<p>Having the microphone stream you can use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext">AudioContext</a> interface to make the audio (PCM data) go through different processing nodes before reaching its destination. There are nodes for gain, compressor, panner, and much more. We are going to write a custom node, so we can access the audio samples. For that we add a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ScriptProcessorNode">ScriptProcessorNode</a>.</p>

<pre><code class="language-javascript">function initializeRecorder(stream) {
  var audioContext = window.AudioContext;
  var context = new audioContext();
  var audioInput = context.createMediaStreamSource(stream);
  var bufferSize = 2048;
  // create a javascript node
  var recorder = context.createJavaScriptNode(bufferSize, 1, 1);
  // specify the processing function
  recorder.onaudioprocess = recorderProcess;
  // connect stream to our recorder
  audioInput.connect(recorder);
  // connect our recorder to the previous destination
  recorder.connect(context.destination);
}
</code></pre>

<p>After this, every audio sample will go through the <code>recorderProcess</code> function.</p>

<pre><code class="language-javascript">function recorderProcess(e) {
  var left = e.inputBuffer.getChannelData(0);
}
</code></pre>

<p>We have now PCM data samples from the left channel. Since we are recording in mono we only need the left channel. Now moving on to streaming these chunks to the server.</p>

<h3 id="communication">Communication</h3>

<p>We are using WebSockets to send the samples to the server. The server is going to be written in Node.js.</p>

<p>I started with <a href="http://socket.io/">Socket.IO</a>. When things didn’t work I realised Socket.IO doesn’t support binary communication (in fact, it does now, I made this before it did). <a href="http://binaryjs.com/">BinaryJS</a> does support binary communication, so I moved to it.</p>

<h4 id="setup-binaryjs">Setup BinaryJS</h4>

<p>First add the BinaryJS library.</p>

<pre><code class="language-html">&lt;script src="http://cdn.binaryjs.com/0/binary.js"&gt;&lt;/script&gt;
</code></pre>

<p>Now start a connection.</p>

<pre><code class="language-javascript">var client = new BinaryClient('ws://localhost:9001');
</code></pre>

<p>When ready, create a write stream.</p>

<pre><code class="language-javascript">client.on('open', function() {
  // for the sake of this example let's put the stream in the window
  window.Stream = client.createStream();
}
</code></pre>

<p>Going back to our custom node let’s send the audio to the stream.</p>

<pre><code class="language-javascript">function recorderProcess(e) {
  var left = e.inputBuffer.getChannelData(0);
  window.Stream.write(left);
}
</code></pre>

<p>Everything should be ready on the client side now. Our <code>recorderProcess</code> function is called for each audio chunk, and each is sent to the server.</p>

<p>But we aren’t ready yet! There is one important step missing. WebAudio samples are in Float32. If you choose to send them like this you need to know that <a href="https://developer.mozilla.org/en-US/docs/Web/API/Uint16Array">endianness does matter</a>. I chose to convert them to 16 bit signed integers:</p>

<pre><code class="language-javascript">function convertFloat32ToInt16(buffer) {
  l = buffer.length;
  buf = new Int16Array(l);
  while (l--) {
    buf[l] = Math.min(1, buffer[l])*0x7FFF;
  }
  return buf.buffer;
}

function recorderProcess(e) {
  var left = e.inputBuffer.getChannelData(0);
  window.Stream.write(convertFloat32ToInt16(left));
}
</code></pre>

<p>We are now done with the client code. Moving on to the server.</p>

<h3 id="setting-up-a-server">Setting up a server</h3>

<p>I’m not getting into much detail on the server, I’m just going to show how to put these chunks in a playable media file. I’m assuming you already have <a href="http://nodejs.org/">Node.js</a> installed.</p>

<p>We need <a href="http://binaryjs.com/">BinaryJS</a>, and <a href="https://github.com/TooTallNate/node-wav">node-wav</a> on the server. The first is for communication, and the second accepts raw audio data and outputs a WAV file with a valid WAVE header.</p>

<pre><code class="language-bash">npm init
npm install binaryjs
npm install wav
</code></pre>

<p>Now create the <code>index.js</code> file and start the BinaryJS server.</p>

<pre><code class="language-javascript">var binaryServer = require('binaryjs').BinaryServer;
var wav = require('wav');

var server = binaryServer({port: 9001});

server.on('connection', function(client) {
  ...
});
</code></pre>

<p>Inside the <code>server.on('connection', function)</code> callback node-wav is going to help pipe the stream into a file.</p>

<pre><code class="language-javascript">var fileWriter = null;

client.on('stream', function(stream, meta) {
  var fileWriter = new wav.FileWriter('demo.wav', {
    channels: 1,
    sampleRate: 48000,
    bitDepth: 16
  });
  stream.pipe(fileWriter);
  stream.on('end', function() {
    fileWriter.end();
  });
});

client.on('close', function() {
  if (fileWriter != null) {
    fileWriter.end();
  }
});
</code></pre>

<p>For a better understanding you should read <a href="https://github.com/TooTallNate/node-wav">node-wav</a> document. In fact, you should read the source code since there isn’t much documentation. Simply put, <code>wav.FileWriter</code> accepts a pcm stream and sends it to a media file, setting the right header for the file.</p>

<p>Notice the settings for <code>wav.FileWriter</code> are hardcoded, but they can be sent through the stream. Parameters like sample rate change for each client.</p>

<h2 id="setup-complete">Setup complete</h2>

<p>You are ready to start recording. There is still a long way to go from here. You should probably support restoring the connection if it goes down, and append the audio to the same media.</p>

<h1 id="wrap-it-up">Wrap it up</h1>

<p>You can now start from here and build your own platform with audio recording. Maybe a personal note-taking platform.</p>

<p>This solution allows you to record the microphone while not worrying about upload time and audio loss. The full source code is <a href="https://github.com/gabrielpoca/browser-pcm-stream">here</a>. Feel free to leave any questions and comments.</p>

<h3 id="stackoverflow-related-answers">StackOverflow related answers</h3>

<ul>
  <li><a href="http://stackoverflow.com/questions/21079972/sound-card-detection-for-web/21080953#21080953">Sound card detection for web</a></li>
  <li><a href="http://stackoverflow.com/questions/20876152/playing-pcm-stream-from-web-audio-api-on-node-js">Playing PCM stream from Web Audio API on Node.js</a></li>
  <li><a href="http://stackoverflow.com/questions/20850396/stream-recorded-audio-from-browser-to-server">Stream recorded audio from browser to server</a></li>
</ul>


    </article>
  </div>
</div>

        <footer class="Footer">
  <div class="Page">
    <hr class="Line">

    <p class="Paragraph">
      Interested in working together?
      I'm available
      <a class="Text Text--branding" href="https://twitter.com/gabrielgpoca">for hire!</a>
      Reach me on
      <a class="Text Text--branding" href="https://twitter.com/gabrielgpoca">Twitter</a>.
    </p>

    <p class="Paragraph">
      <span class="Text Text-small">
        Thank you for visting. Feel free to engage with me on
        <a href="https://twitter.com/gabrielgpoca">Twitter</a>.
      </span>
    </p>
  </div>
</footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-48359304-1', 'auto');
ga('send', 'pageview');
</script>

      </div>
    </div>
  </body>
</html>
